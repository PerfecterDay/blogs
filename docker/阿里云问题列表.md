1. 无法登录镜像仓库，推送镜像
	将仓库设置为公开，并在实例管理->访问凭证里边设置密码，并且将访问控制中的白名单删除

2. 推送镜像后，部署时出现 Back-off pulling image ...
	代表镜像拉取错误，部署时拉取镜像时要设置密码

3. 如何创建公网访问入口 ？
   创建服务，服务类型选->负载均衡,公网访问 新建SLB 关联上envoy 服务（你要访问的服务），外部流量策略选 cluster,
   
4. 镜像推送太慢，网络环境
5. redis 5.0 版本太低，7.0不支持集群，切换成6.0
6. 公网入口/redis/mysql 连接只能通过 mobile 连接
7. redis auth 只需要密码即可
8. mysql/redis 需要本地访问，只需要在阿里云实例开启公网访问入口
9. kafka 连接不了，追白名单
10. 如何搭建consul 集群 ？
11. consul 注册时一定要注意 health check / 注册的是IP还是域名，域名会报错
12. 创建负载均衡后，不能删除关联的服务，可以
13. consul 重启后，注册的服务丢失问题 -> https://github.com/hetianyi/spring-cloud-starter-consul-discovery-patch
14. 交易GMT账号互踢问题
15. uatfile upload host 不匹配返回403   ---->  route: { cluster: uatfile-cluster, timeout: { seconds: 10 } ,auto_host_rewrite: true}
16. uatfile/开户转发需要配置 https -----> https://www.envoyproxy.io/docs/envoy/latest/start/quick-start/securing
17. uatfile 返回413,Payload Too Large -- > https://www.envoyproxy.io/docs/envoy/latest/faq/configuration/flow_control#faq-flow-control
18. uatfile 返回408 ---- >  route: { cluster: uatfile-cluster, timeout: { seconds: 60 } ,auto_host_rewrite: true}
19. x-forwarded-for 失效
    Envoy will only append to XFF if the use_remote_address HTTP connection manager option is set to true and the skip_xff_append is set false. This means that if use_remote_address is false (which is the default) or skip_xff_append is true, the connection manager operates in a transparent mode where it does not modify XFF.

	x-envoy-external-address
	It is a common case where a service wants to perform analytics based on the origin client’s IP address. Per the lengthy discussion on XFF, this can get quite complicated, so Envoy simplifies this by setting x-envoy-external-address to the trusted client address if the request is from an external client. x-envoy-external-address is not set or overwritten for internal requests. This header can be safely forwarded between internal services for analytics purposes without having to deal with the complexities of XFF.

## 错误日志
time="2023-02-10T01:55:28Z" level=info msg="Post \"http://user-center-serv:8913/user/app/configuration\": dial tcp 192.168.162.123:8913: connect: connection refused" file:line="/usr/local/gtja/com_gmas/controller/user.go:266" zone=Error

auth.log permission denied

#### GRPC 调用超时失败
time="2023-02-13T08:54:10Z" level=debug msg=/user/tradeLogin/registerTrade file:line="/usr/local/gtja/com_gmas/gateway/gateway.go:163" zone=r.URL.Path
time="2023-02-13T08:54:10Z" level=debug msg="{\"req\":[{\"code\":\"1645\",\"params\":{\"custermer_code\":\"700210\",\"language\":\"1\",\"nulltoken\":\"\",\"password\":\"222222\",\"tradetoken\":\"\",\"username\":\"700210\"},\"params_ext\":{}}]}" file:line="/usr/local/gtja/com_gmas/service/service.go:341" zone="reqjson:"
time="2023-02-13T08:54:11Z" level=debug msg=526565da5adc45df file:line="/usr/local/gtja/com_gmas/tracer/tracer.go:95" zone="traceID:"
time="2023-02-13T08:54:11Z" level=debug msg=/health file:line="/usr/local/gtja/com_gmas/tracer/tracer.go:96" zone=spnctx
time="2023-02-13T08:54:12Z" level=debug msg=08ce985965d75a4a file:line="/usr/local/gtja/com_gmas/tracer/tracer.go:95" zone="traceID:"
time="2023-02-13T08:54:12Z" level=debug msg=/health file:line="/usr/local/gtja/com_gmas/tracer/tracer.go:96" zone=spnctx
time="2023-02-13T08:54:16Z" level=error msg="{\"id\":\"go.micro.client\",\"code\":408,\"detail\":\"context deadline exceeded\",\"status\":\"Request Timeout\"}" file:line="/usr/local/gtja/com_gmas/service/service.go:162" zone=grpc
time="2023-02-13T08:54:16Z" level=debug msg="map[tradeResponse:<nil>]" file:line="/usr/local/gtja/com_gmas/controller/trade.go:98" zone=tradeResp
time="2023-02-13T08:54:16Z" level=warning msg="interface conversion: interface {} is nil, not []interface {}" file:line="/usr/local/gtja/com_gmas/gateway/gateway.go:133" zone=busi_route
time="2023-02-13T08:54:18Z" level=debug msg=627a43ab8bd12d1b file:line="/usr/local/gtja/com_gmas/tracer/tracer.go:95" zone="traceID:"
time="2023-02-13T08:54:18Z" level=debug msg=/health file:line="/usr/local/gtja/com_gmas/tracer/tracer.go:96" zone=spnctx

root@user-center-com-gmas-7988bf8fdc-mzrkv:/usr/local/gtja/com_gmas# curl http://consul-svc:8500/v1/catalog/service/trade-center-service
[{"ID":"40ea1807-616e-4e96-8ed1-d29c8011d641","Node":"master","Address":"10.4.152.174","Datacenter":"dc1","TaggedAddresses":{"lan":"10.4.152.174","lan_ipv4":"10.4.152.174","wan":"10.4.152.174","wan_ipv4":"10.4.152.174"},"NodeMeta":{"consul-network-segment":""},"ServiceKind":"","ServiceID":"trade-center-service-8100","ServiceName":"trade-center-service","ServiceTags":[],"ServiceAddress":"10.4.152.10","ServiceTaggedAddresses":{"lan_ipv4":{"Address":"10.4.152.10","Port":8101},"wan_ipv4":{"Address":"10.4.152.10","Port":8101}},"ServiceWeights":{"Passing":1,"Warning":1},"ServiceMeta":{"gRPC_port":"8101","secure":"false"},"ServicePort":8101,"ServiceSocketPath":"","ServiceEnableTagOverride":false,"ServiceProxy":{"Mode":"","MeshGateway":{},"Expose":{}},"ServiceConnect":{},"CreateIndex":15,"ModifyIndex":208}]root@user-center-com-gmas-7988bf8fdc-mzrkv:/usr/local/gtja/com_gmas# 

#### connection refused 实际上被接受
6212bb1f4e6f118c87b7560083951a9a8d4963c2ce80cd3c65f06473a608f723

time="2023-02-13T11:53:36Z" level=debug msg="&{{\"Session-ID\":\"app\",\"X-Forwarded-For\":\"\",\"userName\":\"\"} 0 -1}" file:line="/usr/local/gtja/com_gmas/controller/user.go:258" zone=Request
time="2023-02-13T11:53:36Z" level=info msg="Post \"http://user-center-serv:8913/user/jyb/getSession\": dial tcp 192.168.162.123:8913: connect: connection refused" file:line="/usr/local/gtja/com_gmas/controller/user.go:266" zone=Error
time="2023-02-13T11:53:36Z" level=debug msg="{\"header\":\"{\\\"Accept\\\":[\\\"*/*\\\"],\\\"Accept-Encoding\\\":[\\\"gzip, deflate\\\"],\\\"Accept-Language\\\":[\\\"zh-CN,zh-Hans;q=0.9\\\"],\\\"Aes-Id\\\":[\\\"1a350684dd2afe28c084960ee3682c5b\\\"],\\\"Ant-Id\\\":[\\\"1676289214283.855957\\\"],\\\"App-Channel\\\":[\\\"AppStore\\\"],\\\"App-Id\\\":[\\\"3E1EEECDB7A577CCA1A2E2C1885DBE7A\\\"],\\\"App-Name\\\":[\\\"gtjagjapp\\\"],\\\"App-Version\\\":[\\\"1.0\\\"],\\\"Bizorigin\\\":[\\\"APP\\\"],\\\"Content-Length\\\":[\\\"15\\\"],\\\"Content-Type\\\":[\\\"application/json\\\"],\\\"Deviceid\\\":[\\\"6212bb1f4e6f118c87b7560083951a9a8d4963c2ce80cd3c65f06473a608f723\\\"],\\\"Devicename\\\":[\\\"aVBob25lIDEy\\\"],\\\"Devicetype\\\":[\\\"70\\\"],\\\"Idfa\\\":[\\\"idfa\\\"],\\\"Model-Type\\\":[\\\"x86_64\\\"],\\\"Nettype\\\":[\\\"wifi\\\"],\\\"Osdevice\\\":[\\\"iPhone Simulator\\\"],\\\"Osversion\\\":[\\\"15.5\\\"],\\\"Platform\\\":[\\\"IOS\\\"],\\\"Session-Id\\\":[\\\"9E69ED1B-5A24-4666-8ADD-27C23DCADAB3\\\"],\\\"System-Version\\\":[\\\"15.5\\\"],\\\"Traceid\\\":[\\\"6212bb1f4e6f118c87b7560083951a9a8d4963c2ce80cd3c65f06473a608f723\\\"],\\\"User-Agent\\\":[\\\"AMGTJAGJ/1.3.0 CFNetwork/1333.0.4 Darwin/21.6.0\\\"],\\\"V\\\":[\\\"1.0\\\"],\\\"Verify-Id\\\":[\\\"32ag74gaeg6b95g6af6g0154d4c9af183805g388ccfbe81a003734372d2ee5a7eafbc4\\\"],\\\"X-Envoy-Expected-Rq-Timeout-Ms\\\":[\\\"10000\\\"],\\\"X-Forwarded-For\\\":[\\\"220.196.192.196\\\"],\\\"X-Forwarded-Proto\\\":[\\\"http\\\"],\\\"X-Request-Id\\\":[\\\"ea9bf550-23a3-41c1-b400-2b97b7d60666\\\"]}\",\"node\":\"user_center_com_gmas_01\",\"path\":\"/user/jyb/getSession\",\"processTime\":1676289216658175967,\"receiveTimeStamp\":1676289216648192987,\"request\":{\"Session-ID\":\"app\",\"X-Forwarded-For\":\"\",\"userName\":\"\"},\"response\":{\"bgStatus\":\"\",\"data\":{},\"msg\":\"\",\"status\":\"0\"}}" file:line="/usr/local/gtja/com_gmas/service/service.go:382" zone=content
time="2023-02-13T11:53:36Z" level=debug msg="{\"header\":\"{\\\"Accept\\\":[\\\"*/*\\\"],\\\"Accept-Encoding\\\":[\\\"gzip, deflate\\\"],\\\"Accept-Language\\\":[\\\"zh-CN,zh-Hans;q=0.9\\\"],\\\"Aes-Id\\\":[\\\"1a350684dd2afe28c084960ee3682c5b\\\"],\\\"Ant-Id\\\":[\\\"1676289214283.855957\\\"],\\\"App-Channel\\\":[\\\"AppStore\\\"],\\\"App-Id\\\":[\\\"3E1EEECDB7A577CCA1A2E2C1885DBE7A\\\"],\\\"App-Name\\\":[\\\"gtjagjapp\\\"],\\\"App-Version\\\":[\\\"1.0\\\"],\\\"Bizorigin\\\":[\\\"APP\\\"],\\\"Content-Length\\\":[\\\"15\\\"],\\\"Content-Type\\\":[\\\"application/json\\\"],\\\"Deviceid\\\":[\\\"6212bb1f4e6f118c87b7560083951a9a8d4963c2ce80cd3c65f06473a608f723\\\"],\\\"Devicename\\\":[\\\"aVBob25lIDEy\\\"],\\\"Devicetype\\\":[\\\"70\\\"],\\\"Idfa\\\":[\\\"idfa\\\"],\\\"Model-Type\\\":[\\\"x86_64\\\"],\\\"Nettype\\\":[\\\"wifi\\\"],\\\"Osdevice\\\":[\\\"iPhone Simulator\\\"],\\\"Osversion\\\":[\\\"15.5\\\"],\\\"Platform\\\":[\\\"IOS\\\"],\\\"Session-Id\\\":[\\\"9E69ED1B-5A24-4666-8ADD-27C23DCADAB3\\\"],\\\"System-Version\\\":[\\\"15.5\\\"],\\\"Traceid\\\":[\\\"6212bb1f4e6f118c87b7560083951a9a8d4963c2ce80cd3c65f06473a608f723\\\"],\\\"User-Agent\\\":[\\\"AMGTJAGJ/1.3.0 CFNetwork/1333.0.4 Darwin/21.6.0\\\"],\\\"V\\\":[\\\"1.0\\\"],\\\"Verify-Id\\\":[\\\"32ag74gaeg6b95g6af6g0154d4c9af183805g388ccfbe81a003734372d2ee5a7eafbc4\\\"],\\\"X-Envoy-Expected-Rq-Timeout-Ms\\\":[\\\"10000\\\"],\\\"X-Forwarded-For\\\":[\\\"220.196.192.196\\\"],\\\"X-Forwarded-Proto\\\":[\\\"http\\\"],\\\"X-Request-Id\\\":[\\\"ea9bf550-23a3-41c1-b400-2b97b7d60666\\\"]}\",\"node\":\"user_center_com_gmas_01\",\"path\":\"/user/jyb/getSession\",\"processTime\":1676289216658175967,\"receiveTimeStamp\":1676289216648192987,\"request\":{\"Session-ID\":\"app\",\"X-Forwarded-For\":\"\",\"userName\":\"\"},\"response\":{\"bgStatus\":\"\",\"data\":{},\"msg\":\"\",\"status\":\"0\"}}" file:line="/usr/local/gtja/com_gmas/service/service.go:384" zone=content




curl http://consul-svc:8500/v1/catalog/datacenters
curl http://consul-svc:8500/v1/catalog/nodes
curl http://consul-svc:8500/v1/catalog/services
curl http://consul-svc:8500/v1/catalog/service/trade-center-service
curl http://localhost:8500/v1/catalog/service/user-center-service

curl http://consul-svc:8500/v1/agent/checks
curl http://consul-svc:8500/v1/agent/services



DiscoveryClientNameResolver No servers found for


session中获取长 token:
gtja-international-app-token:login:session:2402
de4b240d-eac3-4063-b42d-f2bd82559a1b

token-session:
gtja-international-app-token:login:token-session:e7fa2600-5f63-496c-aa7e-f79ed7539a64
gtja-international-app-token:login:token-session:55ed3436-5c03-40f9-b8f1-d45bdd04043e

长token key：
gtja-international-app-token:login:token:86dadc83-260d-420e-8ccd-398b7e28048b
gtja-international-app-token:login:token:55ed3436-5c03-40f9-b8f1-d45bdd04043e

短token key：
gtja-international-app-token:short-token:S-08ab2d20-7777-4015-b0e3-06175297dcbc
gtja-international-app-token:short-token:S-0d464f90-8be0-4d5c-9794-fc865f4806ec