### 离线包部署
{docsify-updated}

- [离线包部署](#离线包部署)
	- [Redis集群安装搭建](#redis集群安装搭建)
- [安装nginx](#安装nginx)
	- [Mysql 主从](#mysql-主从)
	- [lsyncd安装启动](#lsyncd安装启动)
	- [离线包管理平台Manager启动脚本](#离线包管理平台manager启动脚本)
	- [Curl 脚本](#curl-脚本)
	- [PROD](#prod)
- [负载均衡](#负载均衡)

#### Redis集群安装搭建
/root/redis-5.0.14

/root/redis-5.0.14/utils/create-cluster 脚本


### 安装nginx
yum install nginx
systemctl start nginx

#### Mysql 主从

配置文件： `cat /etc/my.cnf`

发版表：
mysql> select * from jh_package_release;
用户表：
sysUser_v2 用户表，密码是MD5值

#### lsyncd安装启动
文档： https://developer.aliyun.com/mirror/epel/?spm=a2c6h.25603864.0.0.21fa5993wQm69R

添加阿里云源：`yum install -y http://mirrors.cloud.aliyuncs.com/epel/epel-release-latest-8.noarch.rpm`
修改repo中的值
```
sed -i 's|^#baseurl=https://download.example/pub|baseurl=http://mirrors.cloud.aliyuncs.com|' /etc/yum.repos.d/epel*
sed -i 's|^metalink|#metalink|' /etc/yum.repos.d/epel*
```
yum install lsyncd

`lsyncd -rsyncssh /usr/share/nginx/html/private/newjhpackage/ 10.4.153.130 /usr/share/nginx/html/private/newjhpackage/`

lsyncd -rsync /home/USER/src remotehost1:dst -rsync /home/USER/src remotehost2:dst 
lsyncd -rsync /home/USER/src /home/USER/dst
lsyncd CONFIGFILE
lsyncd -rsync /home/USER/src remotehost:dst
lsyncd -rsyncssh /home/USER/src REMOTEHOST TARGETDIR


#### 离线包管理平台Manager启动脚本
脚本路径：/home/project/jhpackage_manager/

startup.sh
```
PID=$(cat /home/project/jhpackage_manager/project.pid)
kill -9 $PID
nohup java -jar -Dfastjson.parser.safeMode=true jh-manager.jar --server.port=9097 --spring.profiles.active=dat --logging.level.com.gtja.app=INFO --schedule.select.database=1 \
--release-cluster-redis-config.clusterNodes=10.4.153.131:30001,10.4.153.131:30002,10.4.153.131:30003,10.4.153.131:30004,10.4.153.131:30005,10.4.153.131:30006 \
--spring.datasource.nrngdatasource.url=jdbc:mysql://localhost:3306/nrng?useUnicode=true\&characterEncoding=utf8\&zeroDateTimeBehavior=convertToNull \
--spring.datasource.nrngdatasource.username=root --spring.datasource.nrngdatasource.password=Gjgj123456! --gjpackage.serverurl=http://127.0.0.1/guojih5_prd/ \
--jhpakcage.savePath=/usr/share/nginx/html/private/newjhpackage/ \
--jhpakcage.saveUrl=http://uat-mobileapp.gtjaidemo.com:8002/private/newjhpackage/ >> /dev/null &
echo $! > /home/project/jhpackage_manager/project.pid
```

参数解释：
1. `--gjpackage.serverurl` ：拉取原始离线包的地址，`/usr/share/nginx/html/guojih5_prd` ,只需要zip 包
2. `--jhpakcage.saveUrl` ：保存差异包/离线包的地址 ,`/usr/share/nginx/html/private/newjhpackage/`


日志路径：tail -f /home/logs/new_jhpackage/jhpackage.2023-07-05.log


web.zip和json文件


#### Curl 脚本
http://uat-mobileapp.gtjaidemo.com:8001/common/jhmanager/41700000


curl --location --request POST 'http://uat-mobileapp.gtjaidemo.com:8001/common/jhmanager/v1/41700010' \
--header 'Content-Type: application/json' \
--header 'Platform: Android' \
--header 'App-Version: 1.0.0' \
--data-raw '{
    "module":{
        "convertible-bond":"1.0.0",
        "integrated-query":"1.0.0",
        "contract-extension":"1.0.0",
        "dbphz":"1.0.0",
        "newstock":"1.0.0",
        "nrng":"2.1.6"
    },
    "appId":"56"
}'


1.
curl --location --request POST 'http://uat-mobileapp.gtjaidemo.com:8001/common/jhmanager/v1/41700010' \
--header 'Content-Type: application/json' \
--header 'Platform: iOS' \
--header 'App-Version: 1.0.0' \
--data-raw '{
    "module":{
    },
    "appId":"56"
}'


{
	"status": "0",
	"bgStatus": "0",
	"msg": "success",
	"data": {
		"packageInfo": [
			{
				"packageId": "app03",
				"packageVersion": "1.0.0",
				"appUpdateTime": "2",
				"appUpdateStrategy": "1",
				"isYuZhi": "0",
				"allUrl": "http://uat-mobileapp.gtjaidemo.com:8002/private/newjhpackage/56/app03/1.0.0/originEncry/app03_data.zip",
				"diffUrl": "",
				"releaseStatus": "1",
				"androidVersionScope": "1.0.0",
				"iosVersionScope": "1.0.0",
				"androidVersionScopeMax": "",
				"iosVersionScopeMax": "",
				"releaseTime": "2023-07-05 13:22:52"
			}
		]
	}
}


2.
curl --location --request POST 'http://uat-mobileapp.gtjaidemo.com:8001/common/jhmanager/v1/41700010' \
--header 'Content-Type: application/json' \
--header 'Platform: Android' \
--header 'App-Version: 1.0.0' \
--data-raw '{
    "module":{
		"price-h5": "0.0.9"
    },
    "appId":"56"
}'


{
	"status": "0",
	"bgStatus": "0",
	"msg": "success",
	"data": {
		"packageInfo": [
			{
				"packageId": "app03",
				"packageVersion": "1.0.1",
				"appUpdateTime": "2",
				"appUpdateStrategy": "1",
				"isYuZhi": "0",
				"allUrl": "http://uat-mobileapp.gtjaidemo.com:8002/private/newjhpackage/56/app03/1.0.1/originEncry/app03_data.zip",
				"diffUrl": "http://uat-mobileapp.gtjaidemo.com:8002/private/newjhpackage/56/app03/1.0.1/zlencry/1.0.0/app03_data.zip",
				"releaseStatus": "1",
				"androidVersionScope": "1.0.0",
				"iosVersionScope": "1.0.0",
				"androidVersionScopeMax": "",
				"iosVersionScopeMax": "",
				"releaseTime": "2023-07-05 13:39:15"
			}
		]
	}
}


#### PROD
alter table jh_package add column manualCdnUrl varchar(255) default null;


### 负载均衡
配置一个ALB支持 path 前缀路由，配置 /private 到原来 8002负载的路由
配置 /common 到原来 8001负载的路由

UAT:
http://uat-mobileapp.gtjaidemo.com:8002/private/newjhpackage/56/price-h5/1.0.3/originEncry/price-h5_data.zip
http://uat-mobileapp.gtjaidemo.com:8001/common/jhmanager/v1/41700010

生产：
https://appapi.gtjai.com/common/jhmanager/v1/41700010
https://news.gtjai.com/private/newjhpackage/yuzhi/gjyw/ios/1.2.0/resource.zip