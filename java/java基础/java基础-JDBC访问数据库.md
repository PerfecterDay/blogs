## JDBC访问数据库
{docsify-updated}

- [JDBC访问数据库](#jdbc访问数据库)
	- [数据库URL](#数据库url)
	- [数据库查询](#数据库查询)
	- [获取生成的键](#获取生成的键)
	- [数据库事物支持](#数据库事物支持)
	- [批量更新](#批量更新)


### 数据库URL

```
jdbc:subprotocol:other stuff 

jdbc:derby://localhost:1527/COREJAVA;create=true
```

### 数据库查询
使用JDBC访问数据库的一般步骤如下：

1. 使用 DriverManager 连接到数据库获取 Connection 对象

	```
	Sting url ="jdbc:postgresql:COREJAVA";
	String username ="dbuser";
	String password ="secret";
	Connection conn = DriverManager.getConnection(url, username, password);
	```

2. 使用 JDBC Statement/PreparedStatement 来执行 SQL 语句
   
   在执行SQL语句之前，首先需要使用 `Connection` 创建一个 `Statement` 对象；  
   接着把要执行的 SQL语句放入字符串中；  
   然后，调用 Statement 接口中的 `executeUpdate` 方法。 `executeUpdate` 方法将返回受 SQL 语句影响的行数，或者对不返回行数的语句返回 0。

   `executeUpdate` 方法既可以执行诸如 INSERT、 UPDATE 和 DELETE 之类的操作，也可以执行诸如 CREATE TABLE 和 DROP TABLE 之类的数据定义语句。但是，执行 SELECT 查询 时必须使用 `executeQuery` 方法。 另外还有一个 `execute` 方法可以执行任意的 SQL语句， 此方法通常只用于由用户提供的交互式查询。

   ```
   Statement stat = conn.createStatement();
   stat.executeUpdate("UPDATE TEST SET NAME='NEW' WHERE ID = 1");
   stat.executeQuery("SELECT * FROM TEST WHERE ID = 1");
   ```

   我们没有必要在每次开始一个这样的查询时都建立新的查询语句 Statement，而是准备一个带有宿主变量的查询语句，每次查询时只需为该变量填入不同的字符串就可以反复多次使用该语句。 这一技术改进了查询性能，每当数据库执行一个查询时，它总是首先通过计算来确定查询策略，以便高效地执行查询操作。 通过事先准备好查询计划并多次重用它，我们就可以确保查询所需的准备步骤只被执行一次。

   在预备查询语句中，每个宿主变量都用“?”来表示。 如果存在一个以上的变量，那么在设置变量值时必须注意“?”的位置。
   ```
   String publishQuery =”SELECT Books.Price, Books.Title FROM Books, Pub1ishers 
   WHERE Books.Pub1ishe_Id=Publishers.Publisher_Id
   AND Publishers.Name=? AND Books.price < ?”;
   PreparedStatement stat =conn.prepareStatement(publishQuery);
   stat.setString(1,name);
   stat.setDouble(2,price);
   ```

   如果想要重用已经执行过的预备查询语句，那么除非使用 `setXXX` 方法或调用 `clearParameters` 方法，否则所有宿主变量 的绑定都不会改变。 这就意味着，在从一个查询到另一个查询的过程中，只需使用 `setXxx` 方法重新绑定那些需要改变的变量即可。

3. 使用 ResultSet 对象获取查询结果
   
   当我们执行查询操作时，通常感兴趣的是查询结果。`executeQuery` 方法会返回一个 `ResultSet` 类型的对象，可以通过它来每次一行地迭代遍历所有查询结果。
   对于 ResultSet 接口，迭代器初始化时被设定在第一行之前的位直，必须调用 next 方法将它移动到第一行。 另外，它没有 hasNext 方法，我们需要不断地调用 next，直至该方法返回 false。

   ```
   ResultSet rs = stat.executeQuery("SELECT * FROM TEST WHERE ID = 1");
   while(rs.next()){
	String isbn = rs.getString(1);
	double price = rs.getDouble("Price");
   }
   ```
   使用数字型参数效率更高一些，但是使用字符串参数可以使代码易于阅读和维护。

### 获取生成的键
```
stat.executeUpdate (insertStatment, Statement.RETURN_GENERATED_KEYS) ; 
ResultSet rs = stat.getGeneratedKeys();
if(rs.next()){
	int key = rs.getInt(1);
	....
}
```
如果 `autogenerated` 被设置为 `Statement.RETURN_GENERATED_KEYS` ，并且该语句是一条 INSERT 语句，那么第一列中就是自动生成的键。

### 数据库事物支持
默认情况下，数据库连接处于**自动提交模式**(autocommit mode)。 每个SQL语句一旦被执行便被提交给数据库。一旦命令被提交，就无法对它进行回滚操作。在使用事务时，需要关闭这个默认值:
```
conn.setAutoCommit(false);

Statement stat = conn.createStatement();
stat.executeUpdate(command1);
stat.executeUpdate(command2);
stat.executeUpdate(command3);

conn.commit(); //如果上述语句执行成功
conn.rollback();//如果语句执行失败
```

### 批量更新
假设有一个程序需要执行许多 INSERT 语句，以便将数据填人数据库表中，此时可以使用批量更新的方法来提高程序性能。 在使用批量更新（ batch update ）时，一个语句序列作为一批操作将同时被收集和提交。

处于向一批中的语句可以是 INSERT 、 UPDATE 和 DELETE 等操作，也可以是数据库定义语句，如 CREATE TABLE 和 DROP TABLE 。 但是，在批量处理中添加 SELECT 语句会抛出异常（从概念上讲，批量处理中的 SELECT 语句没有意义，因为它会返回结果集，而并不更新数据库）。

为了执行批量处理，首先必须使用通常的办法创建一个 Statement 对象：
```Statement stat = conn. createStatement();```
现在，应该调用 `addBatch` 方法，而非 `executeUpdate` 方法 ：
```
String command = "CREATE TABLE . . . "
stat.addBatch (command) ;

while(...){
command = "INSE RT INTO . . . VALUES ('+.-·+')"; 
stat.addBatch(command);
}
```

最后，提交整个批量更新语句：
```int [] counts = stat.executeBatch(); ```