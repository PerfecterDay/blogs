# IP协议
{docsify-updated}

- [IP协议](#ip协议)
    - [IP地址](#ip地址)
      - [特殊IP地址](#特殊ip地址)
    - [IP首部](#ip首部)
    - [IP路由表](#ip路由表)
      - [IP路由过程](#ip路由过程)
      - [IP分片](#ip分片)


IP是TCP/IP协议族中最为核心的协议。所有的TCP、UDP、ICMP及IGMP数据都以IP数据报格式传输。许多刚开始接触TCP/IP的人对IP提供不可靠、无连接的数据报传送服务感到很奇怪，特别是那些具有X.25或SNA背景知识的人。

**不可靠(unreliable)** 的意思是它不能保证IP数据报能成功地到达目的地。IP仅提供最好的传输服务。如果发生某种错误时，如某个路由器暂时用完了缓冲区，IP有一个简单的错误处理算法:丢弃该数据报，然后发送ICMP消息报给信源端。任何要求的可靠性必须由上层来提供(如TCP)。

**无连接(connectionless)** 这个术语的意思是IP并不维护任何关于后续数据报的状态信息。每个数据报的处理是相互独立的。这也说明，IP数据报可以不按发送顺序接收。如果一信源向相同的信宿发送两个连续的数据报(先是A，然后是B)，每个数据报都是独立地进行路由选择，可能选择不同的路线，因此B可能在A到达之前先到达。

### IP地址
<center><img src="pics/ip-address.png" alt="" width="50%"></center>

全0和全1的主机号都是无效的。  
子网划分：将主机号范围内部分比特作为子网号来划分子网。

#### 特殊IP地址
下图中0表示所有比特全为0；-1表示所有比特全为1；netid/subnetid/hostid代表不全为0或全为1的对应字段；子网号栏为空表示没有子网划分。
<center>
<img src="pics/special-ip.png" alt="" width="60%">
<img src="pics/special-ip2.png" alt="" width="60%">
</center>

表的头两项是特殊的源地址，中间项是特殊换回地址，最后四项是广播地址。

有三类IP地址:
+ 单播地址(目的为单个主机)
+ 广播地址(目的端为给定网络上的所有主机)
+ 多播地址(目的端为同一组内的所有主机)

广播和多播**仅应用于UDP**，它们对需将报文同时传往多个接收者的应用来说十分重要。TCP是一个面向连接的协议，它意味着分别运行于两主机(由IP地址确定)内的两进程(由端口号确定)间存在一条连接。

### IP首部
<center><img src="pics/ip-header.png" alt="" width="40%" height=40%></center>

+ 协议版本：目前的协议版本是4，也就是 IPv4
+ 首部长度：4位，单位是4字节，因此IP首部最大长度是 `(2^4-1)*4=60`  字节。
+ 8位服务类型（TOS）:3位优先权字段（现在已被忽略）+ 4位TOS子字段+1位保留字段（设0）
+ 总长度字段:代表整个IP数据报总长度，16位，因此IP数据报最大度是 `2^{16}=65535`字节
+ 标识字段：标识字段唯一地标识主机发送的每一份数据报。通常每发一份报文它的值就会加1
+ 3位标志:
+ 片偏移:
+ TTL(Time to live)生存时间：设置数据报可以经过的最多路由数，一旦经过一个路由，它的值就减1，当为0时，数据报被丢弃
+ 8位协议: 根据它可以识别是哪个协议向IP传送数据.
+ 16位首部校验和:针对IP首部的校验和。先把校验和字段置为0，然后对首部中每个16bit进行二进制反码求和，结果存在校验和字段中。
+ 32位源IP
+ 32位目的IP
+ 任选项：目前包括
    1. 安全和处理限制（用于军事领域）
    2. 记录路径（让每个路由器都记下它的地址）
    3. 时间戳
    4. 宽松的源站选路（为数据指定一系列必须经过的IP地址）
    5. 严格的源站选路（与4类似，但是只能经过这些地址，不能经过其它地址

### IP路由表
IP路由表中的每一项都包含如下信息：

+ 目的IP地址，可以是一个完整的主机地址，也可以是一个网络地址，由表中的标志字段来指定。主机地址的有一个非0的主机号，而网络地址的主机号为0，用以指定网络中的所有主机。
+ 下一站（或下一跳）路由器（ next-hop router）的I P地址，或者有直接连接的网络 I P地址。下一站路由器是指一个在直接相连网络上的路由器，通过它可以转发数据报。下一站路由器可能不是最终的目的，但是它可以把传送给它的数据报转发到最终目的。
+ 标志。其中一个标志指明目的IP地址是网络地址还是主机地址，另一个标志指明下一站路由器是否为真正的下一跳路由器，还是一个直接相连的接口。
+ 为数据报的传输指定一个网络接口。

#### IP路由过程
当IP层收到某个接口来的数据报时：

1. 如果目的IP地址是本机IP地址之一或者是IP广播地址，那么数据报被送到由IP首部协议字段指定的上层协议模块处理。
2. 否则如果IP层没有设置路由功能，则丢弃该数据报。如果设置了路由功能，则按下述过程对数据报进行转发：
   1. 搜索路由表寻找能与目标IP地址完全匹配的条目（网络号和主机号都匹配），如果找到，则把数据报转发给该表目指定的下一跳路由器或者直接相连的接口。
   2. 搜索路由表查找能与目的网络号相匹配的表目。这里需要用到子网掩码。
   3. 搜索路由表寻找标为默认的表目，将数据报转发给该表目指定的下一跳路由或接口。
   4. 如果上面这些步骤都没有成功，则返回一个“主机不可达”或“网络不可达”的错误。

通常下一跳的路由器或主机都是与本路由器在同一个局域网的，把数据报转发给下一跳的过程中，不会修改数据报的目的目的IP，而是会修改数据链路层的源和目的MAC地址，如果没有下一跳的MAC地址，则需要ARP协议先获取目的MAC地址。IP数据报在整个网络传播过程中，IP地址一般是不会变的。

#### IP分片
物理网络层一般要限制每次发送数据帧的最大长度MTU。任何时候IP层接收到一份要发送的IP数据报时，它要判断向本地哪个接口发送数据(选路)，并查询该接口获得其MTU。IP把MTU与数据报长度进行比较，如果需要则进行分片。分片可以发生在原始发送端主机上，也可以发生在中间路由器上。

把一份IP数据报分片以后，只有到达目的地才进行重新组装(这里的重新组装与其他网络协议不同，它们要求在下一站就进行进行重新组装，而不是在最终的目的地)。重新组装由目的端的IP层来完成，其目的是使分片和重新组装过程对运输层(TCP和UDP)是透明的，除了某些可能的越级操作外。已经分片过的数据报有可能会再次进行分片(可能不止一次)。IP首部中包含的数据为分片和重新组装提供了足够的信息。

当IP数据报被分片后，每一片都成为一个分组，具有自己的IP首部，并在选择路由时与其他分组独立。这样，当数据报的这些片到达目的端时有可能会失序，但是在IP首部中有足够的信息让接收端能正确组装这些数据报片。

**IP数据报**是指IP层端到端的传输单元(在分片之前和重新组装之后)，**分组**是指在IP层和链路层之间传送的数据单元。一个分组可以是一个完整的IP数据报，也可以是IP数据报的一个分片。

<center><img src="pics/ip-fragment.png" width="40%"></center>
<center><img src="pics/ip-split.jpg" width="60%"></center>

尽管IP分片过程看起来是透明的，但有一点让人不想使用它:即使只丢失一片数据也要重传整个数据报。为什么会发生这种情况呢?因为IP层本身没有超时重传的机制——由更高层来负责超时和重传(TCP有超时和重传机制，但UDP没有。一些UDP应用程序本身也执行超时和重传)。当来自TCP报文段的某一片丢失后，TCP在超时后会重发整个TCP报文段，该报文段对应于一份IP数据报。没有办法只重传数据报中的一个数据报片。事实上，如果对数据报分片的是中间路由器，而不是起始端系统，那么起始端系统就无法知道数据报是如何被分片的。就这个原因，经常要避免分片