# Springboot 优雅停机
{docsify-updated}

## JVM 支持的优雅停机
JVM 的优雅关闭（Graceful Shutdown） 是指在关闭 Java 应用程序时，不是直接强制终止进程，而是让程序有机会：
+ 完成当前正在执行的任务
+ 正确释放资源（数据库连接、文件句柄、线程池等）
+ 通知其他系统或服务
+ 保证数据一致性和完整性
+ 输出必要的日志信息

最终让系统以一种“干净、安全、不影响业务状态”的方式停止运行。

JVM 在接收到关闭信号（如 SIGTERM）时，会执行开发者使用 `Runtime.getRuntime().addShutdownHook(...)` 注册的钩子方法，并且可以注册多个：
```
public static void main(String[] args) throws InterruptedException {
    Runtime.getRuntime().addShutdownHook(new Thread(() -> {
        System.out.println("JVM 正在关闭，开始执行清理操作...");
        // 关闭线程池、数据库连接等
    }));

    Runtime.getRuntime().addShutdownHook(new Thread(() -> {
        System.out.println("JVM 正在关闭2，开始执行清理操作...");
        // 关闭线程池、数据库连接等
    }));

    Thread.sleep(100000);
}
```

常见的能触发优雅关闭的方式：
+ `System.exit(0)`
+ `Ctrl + C（发送 SIGINT）`
+ `kill（默认 SIGTERM）`
+ 应用容器 stop（如 Spring Boot stop）

但是 `kill -9（SIGKILL）` 不会触发优雅关闭


## 优雅停机的配置
所有四种嵌入式网络服务器（Jetty、Reactor Netty、Tomcat 和 Undertow）以及基于反应和 servlet 的网络应用程序都支持优雅关机。 它是关闭应用程序上下文的一部分，在停止 SmartLifecycle Bean 的最早阶段执行。 这种停止处理使用一个超时时间，提供一个宽限期，在此期间允许完成现有请求，但不允许有新请求。

不允许新请求的具体方式因所使用的网络服务器而异。 实现可能会在网络层停止接受请求，也可能会返回带有特定 HTTP 状态代码或 HTTP 标头的响应。 使用持久连接也会改变停止接受请求的方式。

Jetty、Reactor Netty 和 Tomcat 将停止在网络层接受新请求。 Undertow 将接受新连接，但会立即响应服务不可用 (503) 的回复。

有些请求可能会在优雅关机阶段开始前被接受。 在这种情况下，**服务器将等待这些活动请求在指定时间内完成工作**。 我们可以使用 `spring.lifecycle.timeout-per-shutdown-phase` 配置属性来配置这一宽限期

启动优雅停机配置：
```
server.shutdown=graceful
spring.lifecycle.timeout-per-shutdown-phase=20s
```

## [优雅停机的问题](/docker/k8s/k8s-pod.md)
当我们用 `start.sh` 来启动 java jar 时：
```
java -jar -Dlogging.level.com.gtja.gjyw=DEBUG -Dspring.config.location=classpath:/configuration/dev/application.yml app.jar
```

使用 `kill start.sh` 并不会杀死 Spring Boot 的 Java 进程

原因：
+ Shell 启动 Java 进程后，如果是以普通方式执行（没有用 exec 或特殊控制），Java 是 **子进程**
+ 当你 kill start.sh（父进程），默认不会连带 kill 子进程
+ 子进程会变成 “孤儿进程”，被操作系统接管，继续运行
+ 所以 Spring Boot 应用 不会退出，也就谈不上优雅关闭

如图:
<center><img src="pics/kill.png" alt=""></center>

快捷的解决方案就是使用 `exec` 启动java 进程， `exec` 的作用是让你的脚本不再作为父进程存在，而是把它变成你要运行的程序本身，这样可以让信号（如 kill）直接作用于目标程序，非常适合用来启动服务程序或实现优雅关闭机制。