#  Mysql 存储过程
{docsify-updated}

新建存储过程：
```
DELIMITER $$
CREATE PROCEDURE user.get_id(OUT uid BIGINT, OUT jaid BIGINT)
BEGIN
  START TRANSACTION;
      UPDATE user_sequence set uid_counter=uid_counter+1, jaid_counter=jaid_counter+1;
      SELECT uid_counter , jaid_counter INTO uid , jaid FROM user_sequence LIMIT 1;
  COMMIT;
END
$$
```

查看：
```
show procedure|function status like '%get%';
show create procedure|function API_CLNTSETTING_LIST;
SHOW PROCEDURE STATUS WHERE Db = 'user';

SELECT ROUTINE_NAME, ROUTINE_TYPE
FROM information_schema.ROUTINES
WHERE ROUTINE_SCHEMA = 'user';
```



删除：
```
DROP PROCEDURE user.get_id
```

修改： 只能先删除，再重建

调用:
1. mysql
不带参数的:
```
call sp_name()
```

带参数的：
```
mysql> CALL get_id(@user_id, @jaid);
Query OK, 0 rows affected (0.028 sec)

mysql> select @user_id, @jaid;
+----------+---------+
| @user_id | @jaid   |
+----------+---------+
|        1 | 3000001 |
+----------+---------+
1 row in set (0.004 sec)
```

1. sql server
```
EXEC sys.sp_who
```



```
CREATE TABLE bills (
   id INTEGER NOT NULL PRIMARY KEY,
   customerName VARCHAR(50) NOT NULL ->
);


CREATE TABLE billItems (
    id INTEGER NOT NULL PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    amountDollars DECIMAL(10, 2) NOT NULL,
    discountDollars DECIMAL(10, 2) NOT NULL,
    billId INTEGER NOT NULL,
    FOREIGN KEY (billId) REFERENCES bills(id) ->
);

INSERT INTO
    bills (id, customerName)
VALUES
(0, 'John Doe'),
(1, 'Jane Doe'),
(2, 'June Doe');

INSERT INTO
    billItems (id, name, amountDollars, billId, discountDollars)
VALUES
(0, 'Old Toyota Yaris', 2100, 0, 0),
(1, 'Old Peugeot 206', 1200, 0, 0),
(2, 'Subaru Forester', 30000, 1, 5),
(3, 'Used Hyundai i10', 6500, 2, 10),
(4, 'Nissan parts', 3500, 2, 0);


DELIMITER //
CREATE PROCEDURE applyDiscount()
BEGIN
DECLARE v_id INT;
DECLARE cur CURSOR FOR SELECT billId FROM billItems GROUP BY billid HAVING SUM(amountDollars) >= 10000;

OPEN cur;
read_loop: LOOP
FETCH cur INTO v_id;
UPDATE
    billItems
set
    discountDollars = discountDollars + 100
WHERE
    billId = v_id;
END LOOP;
CLOSE cur;
END //
DELIMITER ;
```