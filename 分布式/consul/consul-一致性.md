## Consul 一致性
{docsify-updated}

- [Consul 一致性](#consul-一致性)
	- [一致性](#一致性)
	- [可用的一致性模式](#可用的一致性模式)



### 一致性
Consul服务器负责维护状态信息，如服务和节点的注册和健康状态。为了保护这一状态不受Consul服务器潜在故障的影响，这一状态在生产中使用共识协议在三个或更多的Consul服务器之间进行复制。

一个Consul服务器被选为领导者，并作为Consul状态的最终权威。如果大多数Consul服务器同意一个状态变化，领导者负责记录该变化，然后将其分发给非领导者的Consul服务器，即跟随者。由于领导者的状态变化需要时间来传播给追随者，追随者可能对Consul的状态有一个稍微过时的，或 "陈旧的 "看法。

如果一个读取请求是由当前的领导者处理的，那么响应就保证是完全一致的（尽可能是最新的）。如果同样的请求是由跟随者处理的，响应可能不太一致：基于领导者状态的陈旧（过时）的副本。如果响应来自领导者，一致性是最高的。但是，确保只有领导者可以响应请求，可以防止在所有Consul服务器上分散读取请求的负载。

一致性模式控制哪些Consul服务器可以响应读取请求，从而能够控制一致性和性能之间的这种固有的权衡。



### 可用的一致性模式
每个HTTP API端点都记录了其对三种读取一致性模式的支持：

+ stale - Consul DNS查询默认使用stale模式。这种模式允许任何服务器处理读取，不管它是否是领导者。这样做的好处是，读取速度非常快，可扩展性强，陈旧值的可能性较大。结果通常在领先者的50毫秒内是一致的，尽管对这种陈旧性没有上限。由于这种模式允许在没有领导者的情况下进行读取，一个不可用的集群（没有法定人数）仍然可以对查询作出反应。

+ default - Consul HTTP API查询默认使用默认模式。它几乎在所有情况下都是强一致的。然而，有一个小的窗口，在这个窗口中可能会选出一个新的领导者，在此期间，旧的领导者可能会以陈旧的值来响应。这种权衡是快速读取，但有可能是陈旧的值。导致陈旧读取的条件很难触发，大多数客户不需要担心这种情况。另外，请注意，这个竞赛条件只适用于读，而不是写。

+ consistent - 这种模式是强一致性的，没有注意事项。它要求领导者与一个法定的对等体验证它仍然是领导者。这给所有的服务器节点带来了额外的往返次数。这样做的好处是由于额外的往返而增加了延迟。大多数客户不应该使用这个方法，除非他们不能容忍陈旧的读取。


每个端点的HTTP API文档都列出了哪些一致性模式可用于在每个请求的基础上覆盖默认模式。要使用默认以外的支持的一致性模式，在调用端点时将所需的一致性模式作为一个URL查询参数：
+ stale ：使用陈旧的查询参数
+ consistent ：使用一致的查询参数
+ default ：使用领导者查询参数；只有在默认的一致性模式改为陈旧时才相关