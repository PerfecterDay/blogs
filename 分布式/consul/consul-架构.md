## Consul架构
{docsify-updated}

- [Consul架构](#consul架构)
	- [服务发现](#服务发现)
	- [Consul Agent](#consul-agent)



Consul提供一个控制平面，使你能够注册、查询和保护部署在网络上的服务。控制平面是网络基础设施的一部分，它维护一个中央注册表以跟踪服务和它们各自的IP地址。它是一个分布式系统，在节点集群上运行，如物理服务器、云实例、虚拟机或容器。

Consul通过代理与数据平面进行交互。数据平面是网络基础设施中处理数据请求的部分。详情请参考Consul架构。

Consul的核心工作流程包括以下几个阶段：
+ 注册：团队将服务添加到Consul目录中，这是一个中央注册表，可以让服务自动发现对方，而不需要人类操作员修改应用程序代码，部署额外的负载均衡器，或硬编码IP地址。它是所有服务及其地址的运行时真实来源。团队可以使用CLI或HTTP-API手动定义和注册，或者你可以在Kubernetes中用服务同步来自动完成这个过程。服务也可以包括健康检查，以便Consul可以监测不健康的服务。
+ 查询：Consul的基于身份的DNS让你在Consul目录中找到健康的服务。在Consul注册的服务提供健康信息、访问点和其他数据，帮助你控制网络中的数据流。你的服务只能根据你定义的基于身份的策略，通过其本地代理访问其他服务。
+ 安全：在服务定位上行后，Consul确保服务与服务之间的通信是经过认证、授权和加密的。Consul服务网用mTLS保证微服务架构的安全，并且可以根据服务身份允许或限制访问，而不考虑计算环境和运行时间的差异。 

### 服务发现
服务发现帮助你发现、跟踪和监控网络中服务的健康状况。服务发现在服务目录中注册并维护所有服务的记录。这个服务目录作为一个单一的事实来源，允许你的服务查询其他服务和并相互通信。 
服务发现为所有组织提供了好处，从简化的可扩展性到改进的应用弹性。服务发现的一些好处包括：
+ 动态 IP 地址和端口发现
+ 简化的横向服务扩展
+ 将发现逻辑从应用中抽象出来
+ 通过健康检查确保可靠的服务通信
+ 在健康的服务实例上平衡负载请求
+ 通过高速发现实现更快的部署时间
+ 自动化的服务注册和取消注册

服务发现使用一个服务的ID/名字而不是传统的访问信息（IP地址和端口）。这允许你动态地映射服务并跟踪服务目录内的任何变化。然后，服务消费者（用户或其他服务）使用DNS从服务目录中动态地检索其他服务的访问信息。一个服务的生命周期可能如下：

1. 服务消费者通过服务目录提供的唯一的Consul DNS条目(域名或者IP)与 "Web "服务进行通信。
<center><img src="pics/consul-discovery.jpg" width=50%></center>

一个新的 "Web "服务实例用它的IP地址和端口向服务目录注册了自己。随着你的服务的新实例被注册到服务目录，它们将参与到处理服务消费者请求的负载平衡池中。
<center><img src="pics/consul-discovery-2.jpg" width=50%></center>

随着新的服务实例的添加和传统的或不健康的服务实例的删除，服务目录会动态更新。被移除的服务将不再参与处理服务消费者请求的负载平衡池。
<center><img src="pics/consul-discovery-3.jpg" width=50%></center>

在微服务应用中，活跃的服务实例集在一个大的动态环境中频繁变化。这些服务实例依靠服务目录从各自的服务中检索最新的访问信息。可靠的服务目录对于微服务中的服务发现尤为重要，以确保健康、可扩展和高度响应的应用运行。

有两种主要的服务发现模式：客户端发现和服务器端发现。

+ 在使用客户端发现的系统中，服务消费者负责确定可用服务实例的访问信息，并在它们之间进行负载平衡请求。  
  1. 服务消费者查询服务目录
  2. 服务目录检索并返回所有访问信息
  3. 服务消费者选择一个健康的下游服务并直接向其发出请求
<center><img src="pics/consul-discovery-4.jpg" width=50%></center>

+ 在使用服务器端发现的系统中，服务消费者使用一个中介来查询服务目录并向其提出请求。  
  1. 服务消费者查询中介机构（Consul）。
  2. 中介机构查询服务目录并将请求路由到可用的服务实例。
<center><img src="pics/consul-discovery-5.jpg" width=50%></center>

对于现代应用来说，这种发现方法是有优势的，因为开发者可以通过解耦和集中服务发现逻辑使他们的应用更快、更轻。

### Consul Agent
本主题提供了Consul Agent的概述，它是Consul的核心流程。该代理维护成员信息，注册服务，运行检查，响应查询，等等。该代理必须在属于Consul集群的每个节点上运行。

代理在客户端或服务器模式下运行。客户端节点是轻量级的进程，构成了集群的大部分。它们与服务器节点对接，进行大部分操作，并且自己维护的状态非常少。客户端运行在每个运行服务的节点上。

除了核心代理操作外，服务器节点还参与共识法定人数。法定人数是基于Raft协议的，它在故障情况下提供了强大的一致性和可用性。服务器节点应该运行在专用的实例上，因为它们比客户端节点的资源更密集。

Consul集群中的每个代理都会经历一个生命周期。了解生命周期对于建立一个代理与集群的互动以及集群如何对待一个节点的心理模型是很有用的。下面的过程描述了在现有集群背景下的代理生命周期：
1. 一个代理是手动或通过自动或程序化过程启动的。新启动的代理不知道集群中的其他节点。
2. 代理加入集群，这使代理能够发现代理对等物。代理在启动时发出加入命令或根据自动加入的配置加入集群。
3. 关于代理的信息会被八卦到整个集群中。因此，所有的节点最终都会意识到彼此的存在。
4. 如果代理是一个服务器，现有的服务器将开始复制到新节点。