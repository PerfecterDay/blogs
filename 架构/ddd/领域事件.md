# 事件风暴
{docsify-updated}


## 领域事件
领域事件的命名需要使用过去式，表示已经发生的事情，名词在前面，过去式动词在后面。 如 `CustomerRelocated` 表示客户已经被重新分配，`CargoShipped` 表示货柜已经装运。因为领域事件表示与领域相关的事件，不能简单说员工已创建、已删除，而是已雇用、已解雇、已退出。命名需要代表深刻的业务领域含义。

## 命令
事件的发生是有原因的，是什么触发了事件的发生呢？这里引入“命令”这个概念。它表示事件的触发器，通过UI（界面）生成，那么这个命令就是由用户点击“确认”等按钮触发的。命令和事件的区别可以总结如下：

1. 命令表达一个正在发生的动作，有待执行；命令是职责目标，是方向的确定，是主动的。
2. 事件代表已经发生的某个事情，必须响应；事件是不可控的，因为已经发生，无法改变。
3. 命令是请求执行，而事件是执行已完成。 
 命令命名和事件命名也有区别的，命令一般是动词在前，或结尾使用“ing”表示正在发生的动作，区别于事件命名中结尾使用“ed”表示过去式的动作。


## 实例解析：一个典型的事件风暴建模议程
以预订电影票为案例，说明一个典型的事件风暴建模议程。 
第一步：头脑风暴，参会者写出所有他们能够想到的事件。对于订票领域最初想到的可能是：选电影、选座位和付钱，需要将事件写到橙色的便签上，并且用领域事件的格式，名词在前、动词在后，如FilmPicked、SeatPicked、PaymentSucceeded，如图2-10所示。 

<center><img src="pics/ddd-event1.png" width="30%"></center>

“这是最初可能想到的几个事件，非常粗糙，只是与用户相关的事件，领域事件应该是整个领域里发生的事件。 
 有人提出需要关注的业务规则是：如果没有支付成功，选定的座位需要释放。如何使用领域事件表达这种规则？这时需要按照时间线深入流程。 
 第二步：按时间线组织这些事件，创建一个由这些事件组成的合理故事。将他们排成一行，每个人都回顾这个时间线，以确定其中有意义的事件，如图2-11所示。”

<center><img src="pics/ddd-event2.png" width="50%"></center>

“第三步：加入界面和命令。对于那些视觉学习者，可以列出界面，包括其中每个字段，这样的系统蓝图具有用户的角度，便于审视信息的来源和目的地，如图2-12所示。 
在这张图中，加入了界面元素，还有用户操作该界面产生的动作命令，例如显示影片列表，用户会挑选一部影片，命令是PickFilm，将来的系统接收到该命令后，生结果是事件FilmPicked，然后，用户根据显示空位的界面，发出挑选一个座位的命令PickSeat，系统接受后，产生事件SeatPicked，最后，用户根据支付面发出支付命令Pay，支付成功后发出PaymentSucceeded事件。支付可能成功或失败，如果支付失败，则需要放弃选择的座位。”

<center><img src="pics/ddd-event3.png" width="50%"></center>

“第四步：加入流程的因果关系，也就是将命令和事件串联起来，如图2-13所示。”

<center><img src="pics/ddd-event4.png" width="50%"></center>

“当加入逻辑或时间上的因果关系以后，就会发现逻辑漏洞，进而挖掘出业务规则。当座位选择以后，发出SeatPicked事件，然后用户发出支付命令，支付失败以后怎么呢？加入支付失败事件，如图2-14所示。”

<center><img src="pics/ddd-event5.png" width="50%"></center>

支付失败事件PaymentFailed发出后，会自动转换释放座位的命令ReleaseSeat，系统执行后，产生SeatReleased事件表示该座位已经释放。 
第五步：发现有界上下文。将领域中重要的命令和事件使用有颜色便签贴在墙上以后，基本能对问题空间中的领域知识有一定统一认识。那么现在希望划分有界上下文，这样才能分成不同团队分别干活。从图中大概发现可能分三个有界上下文：挑选电影环节‘选座位环节和支付环节，如图2-15所示。”

<center><img src="pics/ddd-event6.png" width="50%"></center>

但是支付失败后，释放空位这对命令和事件是在哪里发生呢？是一个单独的有界上下文吗？释放座位的目的是将空位让给别人，别人才可以挑选这些空位，这些行为在逻辑上是一致的，释放座位和挑选座位应该属于同一个上下文，如图2-16所示。”

<center><img src="pics/ddd-event7.png" width="50%"></center>

这样，这个领域划分为三个不同的有界上下文：选片上下文；座位管理上下文；支付上下文。这三个上下文的名称取决于统一术语，利用这次头脑风暴会议正好统一相关的术语，一旦确定，以后就不要用其他名称，比如不能再称为“挑选电影上下文”“挑选座位上下文”等。 
在这三个上下文中哪个是核心子域呢？其中，座位管理这个有界上下文属于核心子域，它有比较复杂的座位加锁和释放逻辑，如果用户选择了座位后不进行支付怎么办？是不是这里还要加上座位锁定Timeout事件？座位被某个用户锁定20分钟，这20分钟内没有支付，系统将自动执行释放座位命令，同时解锁座位。”

座位管理上下文和支付上下文之间的关系比较密切，座位选择好后才能支付，支付失败后必须释放座位，这两者之间通过什么上下文关系联系比较好？这也是事件风暴会议需要关注和解决的，这同时也决定了两个团队之间的耦合程度。主要是在API的开放主机和“异步消息的发布/订阅两种方式中选择。由于座位锁有20分钟计时（Timeout），所以座位锁的操作对实时同步性要求并不是很高，因此选择异步的发布/订阅方式可能比较合适。 
 事件风暴是一种灵活的研讨会格式，用于协作探索复杂的业务领域，可以直接进入复杂核心并快速轻松地学习它。它具有不同的格式，可以分享全局视觉和知识，了解特定流程并直接进入解决方案领域。”

### 工具
https://robertreppel.github.io/kubel/
